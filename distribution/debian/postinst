#!/bin/sh
set -e


. /usr/share/debconf/confmodule
db_get sonarr/owning_user
USER="$RET"
db_get sonarr/owning_group
GROUP="$RET"
db_get sonarr/config_directory
CONFDIR="$RET"

# Add User and Group
if ! getent group "$GROUP" >/dev/null; then
  groupadd "$GROUP"
fi
if ! getent passwd "$USER" >/dev/null; then
  adduser --system --no-create-home --ingroup "$GROUP" "$USER"
fi

if [ $1 = "configure" ]; then
  # Migrate old Sonarr v3 alpha data dir
  if [ -d "/var/opt/sonarr" ] && [ "$CONFDIR" != "/var/opt/sonarr" ] && [ ! -d "$CONFDIR" ]; then
    if [ ! -f "/var/opt/sonarr/sonarr.db" ] && [ -f "/var/opt/sonarr/.config/Sonarr/sonarr.db" ]; then
      mv "/var/opt/sonarr/.config/Sonarr" "$CONFDIR"
      rm -rf "/var/opt/sonarr"
    else
      mv "/var/opt/sonarr" "$CONFDIR"
    fi
    chown -R $USER:$GROUP "$CONFDIR"
    chmod -R 775 "$CONFDIR"
  fi
fi

# Create data directory
if [ ! -d "$CONFDIR" ]; then
  mkdir -p "$CONFDIR"
  chown -R $USER:$GROUP "$CONFDIR"
fi

# Set permissions on /usr/lib/sonarr
chown -R $USER:$GROUP /usr/lib/sonarr

# Update sonarr.service file
sed -i "s:User=sonarr:User=$USER:g; s:Group=sonarr:Group=$GROUP:g; s:-data=/var/lib/sonarr:-data=$CONFDIR:g" /lib/systemd/system/sonarr.service

#DEBHELPER#

exit 0